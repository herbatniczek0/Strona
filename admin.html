<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admina - Portal Obywatelski</title>
  <style>
    /* admin.html - Panel Admina */
:root {
  /* Kolory admin */
  --admin-primary: #3a0ca3;
  --admin-accent: #7209b7;
  --admin-danger: #f72585;
  --admin-success: #4cc9f0;
  
  /* Dodatkowe zmienne jak wy≈ºej... */
}

/* Override dla panelu admina */
#adminContent {
  --primary: var(--admin-primary);
  --accent: var(--admin-accent);
}

/* Specyficzne style dla panelu admina */
#adminPanelBtn {
  background: white;
  color: var(--admin-primary);
  border: 2px solid white;
  font-weight: 600;
  transition: all 0.2s ease;
}

#adminPanelBtn:hover {
  background: transparent;
  color: white;
}

#adminConfirmBtns {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
}

/* Tabele w panelu admina */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

th, td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

th {
  background: var(--primary);
  color: white;
  font-weight: 500;
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 0.5px;
}

tr:nth-child(even) {
  background: rgba(0, 0, 0, 0.02);
}

tr:hover {
  background: rgba(0, 0, 0, 0.05);
}

/* Akcje w tabelach */
.action {
  padding: 0.5rem 1rem;
  border-radius: var(--radius-sm);
  border: none;
  font-size: 0.8rem;
  font-weight: 500;
}

.action[data-action="delete"] {
  background: var(--admin-danger);
  color: white;
}

/* Logi systemowe */
pre#logList {
  background: var(--card-bg-dark);
  color: var(--text-dark);
  padding: 1.5rem;
  border-radius: var(--radius-md);
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  line-height: 1.5;
}

/* Zak≈Çadki */
.tab {
  animation: fadeIn 0.4s ease;
}

/* Formularze admina */
#addAdmin, #newConsult {
  background: var(--card-bg);
  padding: 1.5rem;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  margin-bottom: 2rem;
}

/* Przyciski eksportu */
#exportCsv, #exportJson {
  background: var(--admin-success);
  margin-right: 1rem;
}

/* Dark mode dla admina */
[data-theme="dark"] #adminContent {
  --primary: var(--admin-accent);
  --card-bg: var(--card-bg-dark);
}

[data-theme="dark"] table {
  border-color: #444;
}

[data-theme="dark"] tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.03);
}

[data-theme="dark"] tr:hover {
  background: rgba(255, 255, 255, 0.08);
}
  </style>
</head>
<body data-theme="">
  <div class="container">
    <h1>Panel Administratora</h1>
    <button id="themeToggle" title="Prze≈ÇƒÖcz motyw">üåô/‚òÄÔ∏è</button>
    <div id="loginPanel">
      <input id="username" placeholder="Login" autocomplete="username" />
      <input id="password" type="password" placeholder="Has≈Ço" autocomplete="current-password" />
      <button id="loginBtn" class="submit">Zaloguj</button>
      <p id="loginError" style="color: var(--error); margin-top: 0.5rem;"></p>
    </div>

    <div id="adminContent" class="hidden">
      <nav>
        <button data-tab="wnioski" class="active">Wnioski</button>
        <button data-tab="konsultacje">Konsultacje</button>
        <button data-tab="admini">Administratorzy</button>
        <button data-tab="eksport">Eksport</button>
        <button data-tab="logi">Logi</button>
        <button data-tab="webhook">Webhook</button>
        <button id="logoutBtn" style="float:right; background:#d9534f;">Wyloguj</button>
      </nav>

      <div id="message"></div>

      <section id="tab-wnioski" class="tab">
        <h2>Lista Wniosk√≥w</h2>
        <div id="wnioskiList">≈Åadowanie...</div>
      </section>

      <section id="tab-konsultacje" class="tab hidden">
        <h2>ZarzƒÖdzanie Konsultacjami</h2>
        <form id="newConsult">
          <div>
            <input name="title" placeholder="Tytu≈Ç" required />
            <textarea name="description" placeholder="Opis"></textarea>
            <button type="submit" class="submit">Dodaj konsultacjƒô</button>
          </div>
        </form>
        <div id="consultList">≈Åadowanie...</div>
      </section>

      <section id="tab-admini" class="tab hidden">
        <h2>ZarzƒÖdzanie Administratorami</h2>
        <form id="addAdmin">
          <div>
            <input name="username" placeholder="Nazwa admina" required />
            <input name="password" type="password" placeholder="Has≈Ço" required />
            <button type="submit" class="submit">Dodaj admina</button>
          </div>
        </form>
        <div id="adminList">≈Åadowanie...</div>
      </section>

      <section id="tab-eksport" class="tab hidden">
        <h2>Eksport danych</h2>
        <button id="exportCsv" class="action">Eksportuj CSV</button>
        <button id="exportJson" class="action">Eksportuj JSON</button>
      </section>

      <section id="tab-logi" class="tab hidden">
        <h2>Logi systemowe</h2>
        <pre id="logList">(Brak log√≥w)</pre>
      </section>

      <section id="tab-webhook" class="tab hidden">
        <h2>Webhook Discord</h2>
        <input id="webhookInput" placeholder="Wklej URL webhooka" style="width: 100%;" />
        <button id="saveWebhook" class="action">Zapisz webhook</button>
        <button id="testWebhook" class="action">Testuj webhook</button>
        <p id="webhookMessage" style="margin-top: 0.5rem;"></p>
      </section>
    </div>
  </div>

  <script>
    const loginPanel = document.getElementById('loginPanel');
    const adminContent = document.getElementById('adminContent');
    const loginError = document.getElementById('loginError');
    const messageBox = document.getElementById('message');
    const themeToggle = document.getElementById('themeToggle');

    const tabs = [...document.querySelectorAll('nav button[data-tab]')];
    const tabSections = [...document.querySelectorAll('.tab')];

    // Helper log system
    let logs = [];
    function log(msg, type = 'info') {
      const prefix = {
        info: '[INFO]',
        error: '[ERROR]',
        success: '[OK]',
        warn: '[WARN]'
      }[type] || '[INFO]';

      const timestamp = new Date().toLocaleString();
      const fullMsg = `${timestamp} ${prefix} ${msg}`;
      logs.push(fullMsg);
      // Keep max 100 logs
      if (logs.length > 100) logs.shift();

      const logList = document.getElementById('logList');
      if(logList) logList.textContent = logs.join('\n');
      console.log(fullMsg);
    }

    // Theme toggle
    themeToggle.onclick = () => {
      const current = document.body.getAttribute('data-theme') || '';
      const next = current === 'dark' ? '' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
    document.body.setAttribute('data-theme', localStorage.getItem('theme') || '');

    // Tab switch
    tabs.forEach(btn => {
      btn.onclick = () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabSections.forEach(sec => sec.classList.add('hidden'));
        const id = 'tab-' + btn.dataset.tab;
        document.getElementById(id).classList.remove('hidden');
      };
    });

    // Show message
    function showMessage(text, type='info') {
      messageBox.textContent = text;
      messageBox.className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      messageBox.style.display = 'block';
      setTimeout(() => messageBox.style.display = 'none', 5000);
    }

    // API helpers
    async function apiGet(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error('B≈ÇƒÖd sieci');
        return await res.json();
      } catch (e) {
        log('B≈ÇƒÖd GET ' + path + ': ' + e.message, 'error');
        showMessage('B≈ÇƒÖd sieci podczas pobierania danych', 'error');
        throw e;
      }
    }
    async function apiPost(path, data) {
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('B≈ÇƒÖd sieci');
        return await res.json();
      } catch (e) {
        log('B≈ÇƒÖd POST ' + path + ': ' + e.message, 'error');
        showMessage('B≈ÇƒÖd sieci podczas wysy≈Çania danych', 'error');
        throw e;
      }
    }
    async function apiDelete(path, data) {
      try {
        const res = await fetch(path, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('B≈ÇƒÖd sieci');
        return await res.json();
      } catch (e) {
        log('B≈ÇƒÖd DELETE ' + path + ': ' + e.message, 'error');
        showMessage('B≈ÇƒÖd sieci podczas usuwania danych', 'error');
        throw e;
      }
    }

    // Login
    document.getElementById('loginBtn').onclick = async () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) {
        loginError.textContent = 'Podaj login i has≈Ço';
        return;
      }
      loginError.textContent = 'Logowanie...';
      try {
        const res = await apiPost('/.netlify/functions/checkAdminAccess', { username: u, password: p });
        if (res.success) {
          localStorage.setItem('adminAuth', 'true');
          localStorage.setItem('adminUser', u);
          loginPanel.classList.add('hidden');
          adminContent.classList.remove('hidden');
          loginError.textContent = '';
          showMessage('Zalogowano pomy≈õlnie', 'success');
          await loadAllData();
        } else {
          loginError.textContent = res.error || 'B≈ÇƒÖd logowania';
          localStorage.removeItem('adminAuth');
          localStorage.removeItem('adminUser');
          log('Nieudane logowanie: ' + u, 'warn');
        }
      } catch {
        loginError.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
      }
    };

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('adminAuth');
      localStorage.removeItem('adminUser');
      loginPanel.classList.remove('hidden');
      adminContent.classList.add('hidden');
      showMessage('Wylogowano');
    };

    // Check auth on load
    window.onload = () => {
      if (localStorage.getItem('adminAuth') === 'true') {
        loginPanel.classList.add('hidden');
        adminContent.classList.remove('hidden');
        loadAllData();
      }
    };

    // Load wnioski (submissions)
async function loadWnioski() {
  const container = document.getElementById('wnioskiList');
  container.textContent = '≈Åadowanie...';
  try {
    const submissions = await apiGet('/.netlify/functions/getSubmissions');
    if (!submissions.length) {
      container.textContent = 'Brak wniosk√≥w';
      return;
    }
    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr><th>ID</th><th>U≈ºytkownik</th><th>Tre≈õƒá</th><th>Data</th></tr>
      </thead>
      <tbody>
        ${submissions.map(s => `
          <tr>
            <td>${s.id}</td>
            <td>${s.name || 'anonim'}</td>
            <td>${s.idea || ''}</td>
            <td>${new Date(s.date).toLocaleString()}</td>
          </tr>`).join('')}
      </tbody>`;
    container.innerHTML = '';
    container.appendChild(table);
    log('Wczytano wnioski');
  } catch (err) {
    console.error('[loadWnioski] B≈ÇƒÖd:', err);
    container.textContent = 'B≈ÇƒÖd ≈Çadowania wniosk√≥w';
  }
}


    // Load consultations
    async function loadConsultations() {
      const container = document.getElementById('consultList');
      container.textContent = '≈Åadowanie...';
      try {
        const consultations = await apiGet('/.netlify/functions/getConsultations');
        if (!consultations.length) {
          container.textContent = 'Brak konsultacji';
          return;
        }
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr><th>ID</th><th>Tytu≈Ç</th><th>Opis</th><th>G≈Çosy</th><th>Akcje</th></tr>
          </thead>
          <tbody>
            ${consultations.map(c => `
              <tr>
                <td>${c.id}</td>
                <td>${c.title}</td>
                <td>${c.description || ''}</td>
                <td>${c.votes || 0}</td>
                <td>
                  <button class="action" data-id="${c.id}" data-action="delete">Usu≈Ñ</button>
                </td>
              </tr>`).join('')}
          </tbody>`;
        container.innerHTML = '';
        container.appendChild(table);

        // Add delete handlers
        container.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.onclick = async () => {
            if(confirm('Na pewno usunƒÖƒá konsultacjƒô?')) {
              try {
                await apiDelete('/.netlify/functions/deleteConsultation', { id: btn.dataset.id });
                showMessage('Konsultacja usuniƒôta', 'success');
                log(`Usuniƒôto konsultacjƒô ID ${btn.dataset.id}`, 'info');
                loadConsultations();
              } catch {
                showMessage('B≈ÇƒÖd usuwania konsultacji', 'error');
              }
            }
          };
        });

        log('Wczytano konsultacje');
      } catch {
        container.textContent = 'B≈ÇƒÖd ≈Çadowania konsultacji';
      }
    }

    // Add new consultation
    document.getElementById('newConsult').onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const title = form.title.value.trim();
      const description = form.description.value.trim();

      if (!title) {
        showMessage('Tytu≈Ç jest wymagany', 'error');
        return;
      }

      try {
        const res = await apiPost('/.netlify/functions/addConsultation', { title, description });
        if(res.success) {
          showMessage('Dodano konsultacjƒô', 'success');
          log(`Dodano konsultacjƒô: ${title}`, 'info');
          form.reset();
          loadConsultations();
        } else {
          showMessage('B≈ÇƒÖd dodawania konsultacji', 'error');
        }
      } catch {
        showMessage('B≈ÇƒÖd dodawania konsultacji', 'error');
      }
    };

    // Load admins
    async function loadAdmins() {
      const container = document.getElementById('adminList');
      container.textContent = '≈Åadowanie...';
      try {
        const admins = await apiGet('/.netlify/functions/getAdmins');
        if (!admins.length) {
          container.textContent = 'Brak administrator√≥w';
          return;
        }
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr><th>ID</th><th>Nazwa</th><th>Akcje</th></tr>
          </thead>
          <tbody>
            ${admins.map(a => `
              <tr>
                <td>${a.id}</td>
                <td>${a.username}</td>
                <td><button class="action" data-id="${a.id}" data-action="delete">Usu≈Ñ</button></td>
              </tr>`).join('')}
          </tbody>`;
        container.innerHTML = '';
        container.appendChild(table);

        // Delete admin
        container.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.onclick = async () => {
            if(confirm('Na pewno usunƒÖƒá administratora?')) {
              try {
                await apiDelete('/.netlify/functions/deleteAdmin', { id: btn.dataset.id });
                showMessage('Administrator usuniƒôty', 'success');
                log(`Usuniƒôto admina ID ${btn.dataset.id}`, 'info');
                loadAdmins();
              } catch {
                showMessage('B≈ÇƒÖd usuwania administratora', 'error');
              }
            }
          };
        });

        log('Wczytano administrator√≥w');
      } catch {
        container.textContent = 'B≈ÇƒÖd ≈Çadowania administrator√≥w';
      }
    }

    // Add admin
    document.getElementById('addAdmin').onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const username = form.username.value.trim();
      const password = form.password.value;

      if (!username || !password) {
        showMessage('Podaj nazwƒô i has≈Ço admina', 'error');
        return;
      }

      try {
        const res = await apiPost('/.netlify/functions/addAdmin', { username, password });
        if(res.success) {
          showMessage('Dodano administratora', 'success');
          log(`Dodano admina: ${username}`, 'info');
          form.reset();
          loadAdmins();
        } else {
          showMessage('B≈ÇƒÖd dodawania administratora', 'error');
        }
      } catch {
        showMessage('B≈ÇƒÖd dodawania administratora', 'error');
      }
    };

    // Export CSV/JSON - tu prosta implementacja (eksportuje listƒô wniosk√≥w i konsultacji)
    async function eksportuj(format) {
      try {
        const wnioski = await apiGet('/.netlify/functions/getSubmissions');
        const konsultacje = await apiGet('/.netlify/functions/getConsultations');

        let content = '';
        if(format === 'csv') {
          // CSV header + data (przyk≈Çad tylko dla wniosk√≥w)
          const csvWnioski = [
            ['ID', 'U≈ºytkownik', 'Tre≈õƒá', 'Data'],
            ...wnioski.map(s => [s.id, s.username||'', `"${(s.content||'').replace(/"/g, '""')}"`, new Date(s.date).toISOString()])
          ].map(row => row.join(',')).join('\n');

          const csvKonsultacje = [
            ['ID', 'Tytu≈Ç', 'Opis', 'G≈Çosy'],
            ...konsultacje.map(c => [c.id, `"${(c.title||'').replace(/"/g, '""')}"`, `"${(c.description||'').replace(/"/g, '""')}"`, c.votes||0])
          ].map(row => row.join(',')).join('\n');

          content = `-- Wnioski --\n${csvWnioski}\n\n-- Konsultacje --\n${csvKonsultacje}`;
        } else {
          // JSON
          content = JSON.stringify({ wnioski, konsultacje }, null, 2);
        }

        // Pobierz plik:
        const blob = new Blob([content], { type: format === 'csv' ? 'text/csv' : 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `export.${format}`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage(`Eksportowano dane do ${format.toUpperCase()}`, 'success');
        log(`Eksportowano dane do ${format.toUpperCase()}`, 'info');
      } catch {
        showMessage('B≈ÇƒÖd eksportu danych', 'error');
      }
    }
    document.getElementById('exportCsv').onclick = () => eksportuj('csv');
    document.getElementById('exportJson').onclick = () => eksportuj('json');

    // Load webhook from localStorage (lub z serwera je≈õli masz)
    const webhookInput = document.getElementById('webhookInput');
    const webhookMsg = document.getElementById('webhookMessage');

    function saveWebhookToStorage(url) {
      localStorage.setItem('discordWebhook', url);
    }
    function getWebhookFromStorage() {
      return localStorage.getItem('discordWebhook') || '';
    }

    webhookInput.value = getWebhookFromStorage();

    document.getElementById('saveWebhook').onclick = () => {
      const url = webhookInput.value.trim();
      if(!url) {
        webhookMsg.textContent = 'Wprowad≈∫ URL webhooka.';
        webhookMsg.style.color = 'var(--error)';
        return;
      }
      saveWebhookToStorage(url);
      webhookMsg.textContent = 'Webhook zapisany.';
      webhookMsg.style.color = 'var(--success)';
      log('Webhook zapisany');
    };

    document.getElementById('testWebhook').onclick = async () => {
      const url = webhookInput.value.trim();
      if (!url) {
        webhookMsg.textContent = 'Wprowad≈∫ URL webhooka.';
        webhookMsg.style.color = 'var(--error)';
        return;
      }
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: 'Testowy webhook z panelu admina' })
        });
        if (res.ok) {
          webhookMsg.textContent = 'Test powi√≥d≈Ç siƒô!';
          webhookMsg.style.color = 'var(--success)';
          log('Test webhooka udany');
        } else {
          webhookMsg.textContent = 'Test nieudany: ' + res.status;
          webhookMsg.style.color = 'var(--error)';
          log('Test webhooka nieudany: ' + res.status, 'error');
        }
      } catch (e) {
        webhookMsg.textContent = 'B≈ÇƒÖd testu webhooka';
        webhookMsg.style.color = 'var(--error)';
        log('B≈ÇƒÖd testu webhooka: ' + e.message, 'error');
      }
    };

    // ≈Åaduj wszystkie dane na start
    async function loadAllData() {
      await loadWnioski();
      await loadConsultations();
      await loadAdmins();
    }
  </script>
</body>
</html>
